var Easing,GridCascade,Noise,ParticleEmitter,ParticleField,QuadTree,SamplePoints,StripeBound,UI,extend=function(t,i){function s(){this.constructor=t}for(var e in i)hasProp.call(i,e)&&(t[e]=i[e]);return s.prototype=i.prototype,t.prototype=new s,t.__super__=i.prototype,t},hasProp={}.hasOwnProperty;Easing=function(){function t(){}return t.linear=function(t,i,s,e){return s*(t/=e)+i},t._linear=function(i){return t.linear(i,0,1,1)},t.quadIn=function(t,i,s,e){return s*(t/=e)*t+i},t._quadIn=function(i){return t.quadIn(i,0,1,1)},t.quadOut=function(t,i,s,e){return-s*(t/=e)*(t-2)+i},t._quadOut=function(i){return t.quadOut(i,0,1,1)},t.cubicIn=function(t,i,s,e){return t/=e,s*t*t*t+i},t._cubicIn=function(i){return t.cubicIn(i,0,1,1)},t.cubicOut=function(t,i,s,e){return t/=e,s*((t-1)*t*t+1)+i},t._cubicOut=function(i){return t.cubicOut(i,0,1,1)},t.elastic=function(t,i,s,e,n){var o,r,u;return null==n&&(n=.3),u=1.70158,r=e*n,o=s,0===t?i:(t/=e,1===t?i+s:(o<Math.abs(s)?(o=s,u=r/4):u=0!==o?r/Const.two_pi*Math.asin(s/o):0,o*Math.pow(2,-10*t)*Math.sin((t*e-u)*Const.two_pi/r)+s+i))},t._elastic=function(i){return t.elastic(i,0,1,1)},t.bounce=function(t,i,s,e){return(t/=e)<1/2.75?7.5625*s*t*t+i:2/2.75>t?s*(7.5625*(t-=1.5/2.75)*t+.75)+i:2.5/2.75>t?s*(7.5625*(t-=2.25/2.75)*t+.9375)+i:s*(7.5625*(t-=2.625/2.75)*t+.984375)+i},t._bounce=function(i){return t.bounce(i,0,1,1)},t}(),this.Easing=Easing,GridCascade=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.startRow=0}return extend(i,t),i.prototype.resetLayout=function(){return this.layout=[],this.startRow=0},i.prototype.occupy=function(t,i,s,e){var n,o,r,u,h,a,p,d;for(n=o=h=t,a=s+t;a>=h?a>o:o>a;n=a>=h?++o:--o)for(u=r=p=i,d=e+i;d>=p?d>r:r>d;u=d>=p?++r:--r)null==this.layout[u]&&(this.layout[u]=[]),this.layout[u][n]=1;return this},i.prototype.findStartRow=function(){var t,i,s,e,n,o,r,u;for(i=this.startRow,n=s=o=this.startRow,r=this.rows;r>=o?r>s:s>r;n=r>=o?++s:--s)for(i=n,t=e=0,u=this.columns;u>=0?u>e:e>u;t=u>=0?++e:--e)if(null!=this.layout[n]&&(null==this.layout[n][t]||this.layout[n][t]<=0))return i;return i},i.prototype.fit=function(t,i){var s,e,n,o,r,u,h,a,p,d,c,l,f,y,m,g,_;for(r=Math.min(t,this.columns),h=p=f=this.startRow,y=this.rows;y>=f?y>p:p>y;h=y>=f?++p:--p)for(o=r,a=0,h+i>=this.rows&&(this.rows+=i),null==this.layout[h]&&(this.layout[h]=[]),u=d=0,m=this.columns;m>=0?m>d:d>m;u=m>=0?++d:--d)if(n=this.layout[h][u],null!=n&&n>0)a=u+1,o=r;else if(o--,0===o){if(s=!0,i>1)for(l=c=g=h,_=h+i;_>=g?_>c:c>_;l=_>=g?++c:--c)if(l<=this.rows&&null!=this.layout[l]&&this.layout[l][a]>0){s=!1;break}if(s)return this.occupy(a,h,r,i),h>this.startRow&&(this.startRow=this.findStartRow()),e=new Rectangle(this.$add(this.cell.size.$multiply(a,h))),e.resizeTo(this.cell.size.$multiply(r,i)),{row:h,column:a,columnSize:r,rowSize:i,bound:e}}return console.error("cannot fit "+h+" "+a+" "+t+" "+i),!1},i}(Grid),this.GridCascade=GridCascade,ParticleEmitter=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.system=null,this.lastTime=0,this.animateID=-1}return extend(i,t),i.prototype.frequency=function(t){return this.period=1e3/t},i.prototype.emit=function(){},i.prototype.animate=function(t,i,s){return t-this.lastTime>this.period?(this.emit(),this.lastTime=t):void 0},i}(Vector),this.ParticleEmitter=ParticleEmitter,ParticleField=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.system=void 0}return extend(i,t),i.prototype.check=function(t,i){var s,e,n,o;for(null==i&&(i=!1),o=[],s=0,e=t.length;e>s;s++)n=t[s],this.hasIntersect(n)?this.work(n):o.push(n);return i?o:t},i.prototype.work=function(t){},i}(Rectangle),this.ParticleField=ParticleField,QuadTree=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.quads=!1,this.items=[],this.depth=0,this.max_depth=6,this.max_items=2}return extend(i,t),i.prototype.getQuads=function(t,i){var s,e,n;if(null==i&&(i=[]),this.intersectPoint(t)&&(i.push(this),this.quads)){n=this.quads;for(s in n)e=n[s],e.intersectPoint(t)&&e.getQuads(t,i)}return i},i.prototype.getItems=function(t){var i,s,e;if(this.intersectPoint(t)){if(!this.quads)return this.items;if(this.quads){e=this.quads;for(i in e)if(s=e[i],s.intersectPoint(t))return s.getItems(t)}}return[]},i.prototype.addToQuad=function(t){var i,s,e,n;if(!t)return-1;if(this.quads){n=this.quads;for(s in n)if(e=n[s],i=e.addToQuad(t),i>0)return i;return-1}return!this.quads&&this.intersectPoint(t)?this.items.length>=this.max_items?this.depth<this.max_depth?(this.splitQuad(),this.addToQuad(t)):-1:(this.items.push(t),this.depth):-1},i.prototype.splitQuad=function(){var t,i,s,e,n,o,r,u,h,a,p,d,c,l;this.quads=this.quadrants(),a=this.quads;for(e in a)h=a[e],h.depth=this.depth+1;for(p=this.items,i=n=0,o=p.length;o>n;i=++n)s=p[i],t=this.addToQuad(s),t>this.depth&&(this.items[i]=null);for(d=this.items,c=[],u=0,r=d.length;r>u;u++)l=d[u],c.push(l?void 0:this.items.splice(l,1));return c},i.prototype.resetQuad=function(){var t,i,s;if(this.items=[],this.quads){s=this.quads;for(t in s)i=s[t],i.resetQuad();return this.quads=!1}},i}(Rectangle),this.QuadTree=QuadTree,SamplePoints=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.bestcandidate=null,this.poisson=null,this.bound=null,this.boundsize=null}return extend(i,t),i.prototype.setBounds=function(t,i){return null==i&&(i=!1),i&&this.set(t),this.bound=new Rectangle(this).size(t.size())},i.prototype.bestCandidateSampler=function(){return this.points=[],this.bound||(this.bound=(new Rectangle).size(500,500)),this.boundsize=this.bound.size(),this.bestcandidate={halfsize:this.boundsize.$divide(2),quartersize:this.boundsize.$divide(4),maxDist:this.boundsize.x*this.boundsize.x+this.boundsize.y*this.boundsize.y},this},i.prototype.poissonSampler=function(t){var i;return this.points=[],this.bound||(this.bound=(new Rectangle).size(500,500)),this.boundsize=this.bound.size(),i=t*Math.SQRT1_2,this.poisson={grid:[],gridWidth:Math.ceil(this.boundsize.x/i),gridHeight:Math.ceil(this.boundsize.y/i),cellSize:i,radius:t,radius2:t*t,R:3*t*t,queue:[],queueSize:0,sampleSize:0,sincos:Util.sinCosTable()},this},i.prototype.sample=function(t,i){var s,e,n,o,r,u,h,a,p,d,c,l,f,y,m;if(null==t&&(t=10),null==i&&(i=!1),this.poisson&&"poisson"===i){if(this.poisson.sampleSize>0&&0===this.poisson.queueSize)return!1;if(!this.poisson.sampleSize)return this._poissonSample(this.bound.x+this.boundsize.x/2,this.bound.y+this.boundsize.y/2);for(;this.poisson.queueSize;){for(o=Math.floor(Math.random()*this.poisson.queueSize),f=this.poisson.queue[o],r=u=0,c=t;c>u;r=u+=1)if(s=Math.floor(360*Math.random()),d=Math.sqrt(Math.random()*this.poisson.R+this.poisson.radius2),y=f.x+d*this.poisson.sincos.cos[s],m=f.y+d*this.poisson.sincos.sin[s],y>=this.bound.x&&y<this.boundsize.x&&m>=this.bound.y&&m<this.boundsize.y&&this._poissonCheck(y,m))return this._poissonSample(y,m);this.poisson.queue[o]=this.poisson.queue[--this.poisson.queueSize],this.poisson.queue.length=this.poisson.queueSize}return!0}if(this.bestcandidate){for(e=null,n=-1,o=h=0,l=t;l>h;o=h+=1){if(p=new Vector(this.bound.x+this.boundsize.x*Math.random(),this.bound.y+this.boundsize.y*Math.random()),0===this.points.length){e=p;break}a=this._bestCandidateCheck(p),a>n&&(e=p,n=a)}return e&&this.points.push(e),e}},i.prototype._bestCandidateCheck=function(t){var i,s,e,n,o,r,u,h,a,p;for(i=this.bestcandidate.maxDist,o=new Rectangle(t.x-this.bestcandidate.quartersize.x,t.y-this.bestcandidate.quartersize.y).size(this.bestcandidate.halfsize.x,this.bestcandidate.halfsize.y),a=function(){var t,i,s,e;for(s=this.points,e=[],t=0,i=s.length;i>t;t++)r=s[t],o.intersectPoint(r)&&e.push(r);return e}.call(this),u=0,h=a.length;h>u;u++)p=a[u],e=p.x-t.x,n=p.y-t.y,s=e*e+n*n,i>s&&(i=s);return i},i.prototype._poissonSample=function(t,i){var s;return s=new Point(t,i),this.poisson.queue.push(s),this.poisson.grid[this.poisson.gridWidth*(i/this.poisson.cellSize|0)+(t/this.poisson.cellSize|0)]=s,this.poisson.sampleSize++,this.poisson.queueSize++,s},i.prototype._poissonCheck=function(t,i){var s,e,n,o,r,u,h,a,p,d,c,l,f,y,m,g;for(n=Math.floor(t/this.poisson.cellSize),u=Math.floor(i/this.poisson.cellSize),o=Math.max(n-2,0),h=Math.max(u-2,0),r=Math.min(n+3,this.poisson.gridWidth),a=Math.min(u+3,this.poisson.gridHeight),u=p=l=h,f=a;f>p;u=p+=1)for(c=u*this.poisson.gridWidth,n=d=y=o,m=r;m>d;n=d+=1)if(g=this.poisson.grid[c+n],g&&(s=g.x-t,e=g.y-i,s*s+e*e<this.poisson.radius2))return!1;return!0},i.bestCandidate=function(t,i,s){var e,n,o,r,u,h,a,p,d,c,l,f;for(null==s&&(s=10),f=t.size(),r=f.$divide(2),c=f.$divide(4),a=f.x*f.x+f.y*f.y,e=function(t){var s,e,n,o,u,h,p,d,l,f;for(s=a,u=new Rectangle(t.x-c.x,t.y-c.y).size(r.x,r.y),l=function(){var t,s,e;for(e=[],t=0,s=i.length;s>t;t++)h=i[t],u.intersetPoint(h)&&e.push(h);return e}(),p=0,d=l.length;d>p;p++)f=l[p],n=f.x-t.x,o=f.y-t.y,e=n*n+o*o,s>e&&(s=e);return s},n=null,o=-1,u=h=0,l=s;l>=0?l>h:h>l;u=l>=0?++h:--h){if(d=new Vector(t.x+f.x*Math.random(),t.y+f.y*Math.random()),0===i.length)return d;p=e(d),p>o&&(n=d,o=p)}return n},i}(PointSet),this.SamplePoints=SamplePoints,StripeBound=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.frequency=new Point,this.stripes=new Point,this.method="frequency",this.mask=null}return extend(i,t),i.prototype.setFrequency=function(t,i){return this.frequency=new Vector(t,i),this.method="frequency"},i.prototype.setStripes=function(t,i){return this.stripes=new Point(t,i),this.method="stripes"},i.prototype.getStripes=function(){var t,i,s,e,n,o,r,u,h,a,p,d;for(d=this.size(),p={columns:[],rows:[]},n="frequency"===this.method?this.frequency.clone():d.$divide(this.stripes).floor(),i=d.$divide(n),t=o=0,h=n.y-1;h>=0?h>=o:o>=h;t=h>=0?++o:--o)e=i.y*t,u=new Pair(0,e).to(d.x,e+i.y).add(this),u.p1.add(this),p.rows.push(u);for(t=r=0,a=n.x-1;a>=0?a>=r:r>=a;t=a>=0?++r:--r)s=i.x*t,u=new Pair(s,0).to(s+i.x+.5,d.y).add(this),u.p1.add(this),p.columns.push(u);return p},i.prototype.getStripeLines=function(){var t,i,s,e,n,o,r,u,h,a,p,d;for(d=this.size(),p={columns:[],rows:[]},n="frequency"===this.method?this.frequency.clone():d.$divide(this.stripes).floor(),i=d.$divide(n),t=o=0,h=n.y;h>=0?h>=o:o>=h;t=h>=0?++o:--o)e=i.y*t,u=new Pair(0,e).to(d.x,e).add(this),u.p1.add(this),p.rows.push(u);for(t=r=0,a=n.x;a>=0?a>=r:r>=a;t=a>=0?++r:--r)s=i.x*t,u=new Pair(s,0).to(s,d.y).add(this),u.p1.add(this),p.columns.push(u);return p},i.prototype.setMask=function(t,i,s){var e,n;return null==s&&(s=!1),this.mask=new Rectangle(this.x,this.y),n=this.size(),s?s=this.$add(s):(e=n.$subtract(t,i).divide(2),s=new Point(this.x+e.x,this.y+e.y)),this.mask.set(s.x,s.y).size(t,i)},i.prototype.anchorMask=function(){var t;return t=this.$subtract(this.mask),this.moveBy(t),this.mask.moveBy(t)},i}(Rectangle),this.StripeBound=StripeBound,UI=function(t){function i(){i.__super__.constructor.apply(this,arguments),this.dragging=!1}return extend(i,t),i.dragTarget=null,i.prototype.animate=function(t,i,s){return s.fillStyle="#f00",Form.rect(s,this)},i.prototype.onMouseAction=function(t,s,e,n){return this.intersectPoint(s,e)&&("drag"!==t||i.dragTarget||(this.dragging=!0,i.dragTarget=this)),this.dragging&&"move"===t&&this.moveTo(s,e).moveBy(this.size().multiply(-.5)),"drop"===t?(this.dragging=!1,i.dragTarget=null):void 0},i}(Rectangle),this.UI=UI,Noise=function(t){function i(){var t;i.__super__.constructor.apply(this,arguments),this.p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,9,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this.perm=function(){var i,s;for(s=[],t=i=0;512>i;t=++i)s.push(this.p[255&t]);return s}.call(this)}return extend(i,t),i.prototype.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],i.prototype.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]],i.prototype.seed=function(t){var i,s,e,n;for(t>0&&1>t&&(t*=65536),t=Math.floor(t),256>t&&(t|=t<<8),e=[],i=s=0;255>=s;i=++s)n=1&i?this.p[i]^255&t:this.p[i]^t>>8&255,e.push(this.perm[i]=this.perm[i+256]=n);return e},i.prototype._dot=function(t,i,s){return t[0]*i+t[1]*s},i.prototype.perlin2d=function(t,i){var s,e,n,o,r,u,h,a,p,d;return null==t&&(t=this.x),null==i&&(i=this.y),s=function(t){return t*t*t*(t*(6*t-15)+10)},e=Math.floor(t)%255,n=Math.floor(i)%255,p=t-e,d=i-n,o=this._dot(this.grad3[(e+this.perm[n])%12],p,d),r=this._dot(this.grad3[(e+this.perm[n+1])%12],p,d-1),u=this._dot(this.grad3[(e+1+this.perm[n])%12],p-1,d),h=this._dot(this.grad3[(e+1+this.perm[n+1])%12],p-1,d-1),a=s(p),Util.lerp(Util.lerp(o,u,a),Util.lerp(r,h,a),s(d))},i.prototype.simplex2d=function(t,i){var s,e,n,o,r,u,h,a,p,d,c,l,f,y,m,g,_,b,z,x,q,v,w,S,M,P,R;return null==t&&(t=this.x),null==i&&(i=this.y),s=.5*(Math.sqrt(3)-1),_=(t+i)*s,a=Math.floor(t+_),c=Math.floor(i+_),e=(3-Math.sqrt(3))/6,b=(a+c)*e,n=a-b,o=c-b,v=t-n,M=i-o,v>M?(p=1,l=0):(p=0,l=1),w=v-p+e,P=M-l+e,S=v-1+2*e,R=M-1+2*e,d=255&a,f=255&c,r=this.perm[d+this.perm[f]]%12,u=this.perm[d+p+this.perm[f+l]]%12,h=this.perm[d+1+this.perm[f+1]]%12,z=.5-v*v-M*M,0>z?y=0:(z*=z,y=z*z*this._dot(this.grad3[r],v,M)),x=.5-w*w-P*P,0>x?m=0:(x*=x,m=x*x*this._dot(this.grad3[u],w,P)),q=.5-S*S-R*R,0>q?g=0:(q*=q,g=q*q*this._dot(this.grad3[h],S,R)),70*(y+m+g)},i}(Vector);